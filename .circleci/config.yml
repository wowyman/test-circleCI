version: 2.1

orbs:
  ruby-rails-setup: later/ruby-rails-setup@0.0.3
  ruby: circleci/ruby@1.1.0

# executors:
#   default:
#     docker:
#       # include node
#       - image: circleci/ruby:<< parameters.ruby_version >>
#         environment:
#           BUNDLE_JOBS: 3
#           BUNDLE_PATH: ./vendor/bundle
#           RAILS_ENV: test
#           DB_USERNAME: db_username
#           DB_NAME: test_database
#           DB_PASSWORD: ""
#       - image: circleci/postgres:<< parameters.psql_version >>
#         environment:
#           POSTGRES_USER: db_username
#           POSTGRES_DB: test_database
#           POSTGRES_PASSWORD: ""
#           POSTGRES_HOST_AUTH_METHOD: trust
#     parameters:
#       ruby_version:
#         type: string
#         default: 2.5.1-stretch-node
#       psql_version:
#         type: string
#         default: "9.6.16"

jobs:
  build:
    docker:
      - image: circleci/ruby:3.0.0
    steps:
      - checkout
      - ruby/install-deps
      - run: gem install bundler
      - run: bundle install
      - run:
          name: deploy app to heroku
          command: git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git master
  rubocop:
    docker:
      - image: circleci/ruby:2.6.7-node-browsers-legacy
        environment:
          RAILS_ENV: test
          MYSQL_HOST: 127.0.0.1
      - image: circleci/mysql:8.0.4
        environment:
          MYSQL_ROOT_PASSWORD:
          MYSQL_DATABASE: sample_app_test
    steps:
      - run:
          name: Rubocop
          command: bundle exec rubocop

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - rubocop:
          requires:
            - build
